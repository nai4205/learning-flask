{% extends "layout.html" %}
{% block content %}
<div class="content-section">
    <form method="POST" action="">
        {{ form.hidden_tag() }}
        <fieldset class="form-group">
            <legend class="border-bottom mb-4">{{ legend }}</legend>

            <div class="form-group">
                {{ form.title.label(class="form-control-label") }}
                {% if form.title.errors %}
                {{ form.title(class="form-control form-control-lg is-invalid") }}
                <div class="invalid-feedback">
                    {% for error in form.title.errors %}
                    <span> {{ error }} </span>
                    {% endfor %}
                </div>
                {% else %}
                {{ form.title(class="form-control form-control-lg") }}
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-control-label">Description</label>
                {% if form.content.errors %}
                {{ form.content(class="form-control form-control-lg is-invalid") }}
                <div class="invalid-feedback">
                    {% for error in form.content.errors %}
                    <span> {{ error }} </span>
                    {% endfor %}
                </div>
                {% else %}
                {{ form.content(class="form-control form-control-lg") }}
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.ingredients.label(class="form-control-label") }}
                {% if form.ingredients.errors %}
                {{ form.ingredients(class="form-control form-control-lg is-invalid") }}
                <div class="invalid-feedback">
                    {% for error in form.ingredients.errors %}
                    <span> {{ error }} </span>
                    {% endfor %}
                </div>
                {% else %}
                <div class="ingredients-input">
                    <div class="ingredient-row">
                        <button type="button" class="btn btn-secondary add-ingredient mt-2 mb-2">+</button>
                        <button type="button" class="btn btn-danger remove-ingredient mt-2 mb-2" disabled>-</button>

                        {{ form.ingredients(class="invisible", rows=1) }}
                    </div>
                </div>
                {% endif %}
                
            </div>

            <div class="form-group pt-3">
                {{ form.submit(class="btn btn-outline-info") }}
            </div>
        </fieldset>
    </form>
</div>

<script>
    // Get the ingredients input container
    const ingredientsContainer = document.querySelector('.ingredients-input');
    
    // Hidden textarea for accumulating ingredient values
    const hiddenIngredientsTextarea = document.querySelector('textarea[name="ingredients"]');
    
    // Single plus button to add a new ingredient field
    const addButton = document.querySelector('.add-ingredient');
    
    // Single remove button to remove the last ingredient field
    const removeButton = document.querySelector('.remove-ingredient');
    
    // Counter to track the number of ingredient fields
    let ingredientCount = 1;
    
    // Function to add a new ingredient input field
    function addIngredientField() {
        const ingredientRow = document.createElement('div');
        ingredientRow.classList.add('ingredient-row');
        
        const ingredientInput = document.createElement('textarea');
        ingredientInput.classList.add('form-control', 'form-control-lg');
        ingredientInput.rows = 1;
        ingredientInput.name = `ingredient_${ingredientCount}`;
        ingredientInput.addEventListener('input', updateHiddenTextarea);
        
        ingredientRow.appendChild(ingredientInput);
        ingredientsContainer.appendChild(ingredientRow);
        
        // Increment the counter
        ingredientCount++;
        
        // Enable the remove button when there's more than one ingredient field
        if (ingredientCount > 1) {
            removeButton.disabled = false;
        }
    }
    
    // Function to remove the last ingredient input field
    function removeLastIngredientField() {
        if (ingredientCount > 1) {
            const lastIngredientRow = ingredientsContainer.lastElementChild;
            const lastIngredientInput = lastIngredientRow.querySelector('textarea');
            
            // Remove the ingredient input field
            ingredientsContainer.removeChild(lastIngredientRow);
            
            // Decrement the counter
            ingredientCount--;
            
            // Disable the remove button if there's only one ingredient field left
            if (ingredientCount === 1) {
                removeButton.disabled = true;
            }
            
            // Update the hidden textarea by removing the text of the removed ingredient
            updateHiddenTextarea();
        }
    }
    
    // Function to update the hidden textarea with accumulated ingredient values
    function updateHiddenTextarea() {
        const ingredientTexts = [];
        for (let i = 1; i < ingredientCount; i++) {
            const ingredientInput = document.querySelector(`textarea[name="ingredient_${i}"]`);
            if (ingredientInput) {
                ingredientTexts.push(ingredientInput.value);
            }
        }
        hiddenIngredientsTextarea.value = ingredientTexts.join('\n');
    }

    // Populate ingredient fields and open text boxes based on stored data
    var storedIngredients = {{ form.ingredients.data|tojson }};
    if(storedIngredients){
        var array = storedIngredients.split('\n').map(function(item) {
        return item.trim();
    });
    }
    
    storedIngredients = array
    const storedIngredientsLength = parseInt({{ session['ingredients_len'] }});
    
    // Check if there are stored ingredients
    if (storedIngredients && Array.isArray(storedIngredients) && storedIngredientsLength > 0) {
        // Open the correct number of text boxes
        while (ingredientCount <= storedIngredientsLength) {
            addIngredientField();
        }
        
        // Populate the text boxes with stored ingredients
        for (let i = 0; i < storedIngredients.length; i++) {
            const ingredientInput = document.querySelector(`textarea[name="ingredient_${i+1}"]`);
            if (ingredientInput) {
                ingredientInput.value = storedIngredients[i];
            }
        }
    }
    
    // Add event listener to the plus button to add new ingredient fields
    addButton.addEventListener('click', addIngredientField);
    
    // Add event listener to the remove button to remove the last ingredient field
    removeButton.addEventListener('click', removeLastIngredientField);
</script>




<!-- ingredients = {{form.ingredients.data|tojson}};
ingredients_len = {{session['ingredients_len']}}

ingredients.split('\n')
for(i in ingredients){
    if (ingredients[i].length != 0){
        console.log(ingredients[i]);
    }
} -->










{% endblock content %}
